name: Release

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest]
    env:
      CI: true
      NODE_ENV: production
    steps:
    - uses: actions/checkout@v1
    - uses: actions/setup-node@v1
      with:
        node-version: 12
    - name: Prepare for app notarization
      if: startsWith(matrix.os, 'macos')
      # Import Apple API key for app notarization on macOS
      run: |
        mkdir -p ~/private_keys/
        echo '${{ secrets.APPLE_DEVELOPER_API_KEY }}' > ~/private_keys/AuthKey_${{ secrets.APPLE_DEVELOPER_API_KEY_ID }}.p8
    - name: Install
      run: |
        yarn install --production=false
    - name: Lint
      run: |
        yarn run lint
    - name: Build
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        APPLE_DEVELOPER_API_KEY_ID: ${{ secrets.APPLE_DEVELOPER_API_KEY_ID }}
        APPLE_DEVELOPER_API_ISSUER_ID: ${{ secrets.APPLE_DEVELOPER_API_ISSUER_ID }}
        CSC_LINK: ${{ secrets.APPLE_DEVELOPER_CERTS }} # base64 -i certs.p12 -o encoded.txt
        CSC_KEY_PASSWORD: ${{ secrets.APPLE_DEVELOPER_CERTS_PASSWORD }}
      run: |
        yarn run dist:build
        yarn run dist:pack --publish always
